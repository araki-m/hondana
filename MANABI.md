# 開発の学び (MANABI)

## 1. html5-qrcode と React の DOM 競合

**問題**: html5-qrcode はDOMを直接操作する。Reactが Scanner コンポーネントをアンマウントすると、両者のDOM操作が競合しiOS Chromeで白画面クラッシュが発生した。

**解決**: Scanner を条件付きレンダリング（アンマウント）せず、`display:none` で非表示にする。DOM要素を常に維持することで競合を回避。

**教訓**: DOM直接操作系のライブラリ（html5-qrcode, Google Maps, D3等）をReactで使う場合、**アンマウントではなく非表示で制御する**のが安全。

## 2. 非同期クリーンアップの罠

**問題**: `useEffect` のクリーンアップで `scanner.stop()`（非同期）を await せずに `scanner.clear()` を呼んでいた。停止完了前にDOMをクリアしようとして不整合が発生。

**解決**: `scanner.stop().then(() => scanner.clear())` のチェーンにし、停止完了後にクリアを実行。

**教訓**: クリーンアップ内の非同期処理は**実行順序を保証する**必要がある。

## 3. モバイル実機デバッグの手段

**問題**: iOS Chrome では Chrome DevTools が使えない（WebKitエンジンのため）。白画面の原因が不明だった。

**解決**: 3段階のエラー検知を実装。
- 画面上のデバッグログ（状態遷移の可視化）
- Error Boundary（Reactレンダリングエラー捕捉）
- グローバルエラーハンドラ（未捕捉例外の表示）

**教訓**: モバイル向けアプリでは**画面上にデバッグ情報を出せる仕組み**を最初から用意しておくと、実機問題の切り分けが速い。

## 4. PWA キャッシュとバージョン管理

**問題**: コード修正をデプロイしても、PWA の Service Worker キャッシュが古いバージョンを返し続け、修正が反映されなかった。

**解決**: トップ画面にバージョン表示を追加し、デプロイ後にユーザーが新バージョンを受け取れているか目視確認できるようにした。

**教訓**: PWAでは**バージョン表示は必須**。キャッシュ問題の切り分けに不可欠。

## 5. 段階的な問題切り分け

最初の修正（try/catch追加）では解決せず、デバッグログ追加でも情報が得られず、3回目で原因（DOM競合によるReactクラッシュ）を特定できた。

**教訓**: 「ログが出ない」という情報自体が重要な手がかり。問題の発生箇所を**消去法で絞り込む**アプローチが有効。
